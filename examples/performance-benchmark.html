<!doctype html>
<html>
  <head>
    <title>Two.js: Performance Benchmark</title>
    <meta charset="utf-8">
    <link rel="shortcut icon" type="image/gif" href="../images/favicon.gif">
    <link rel="stylesheet" type="text/css" href="../styles/performance.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Ubuntu+Mono:400,400italic">
    <script type="text/javascript" src="//use.typekit.net/edp1hux.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <script src="../third-party/jquery.js"></script>
    <script src="../third-party/two.js"></script>
    <script src="../third-party/url.js"></script>
  </head>
  <body>
    <div id="content">
      <div id="stage"></div>
      <ul id="controls">
        <li class="renderers">
          <ul class="select">
            <li class="title"><span>Renderers</span></li>
            <li class="item" name="svg"><span>SVG</span></li>
            <li class="item" name="canvas"><span>Canvas</span></li>
            <li class="item" name="webgl"><span>WebGL</span></li>
          </ul>
        </li>
        <li class="shapes">
          <ul class="checkbox">
            <li class="title"><span>Shapes</span></li>
            <li class="item" name="triangle"><span>Triangle</span></li>
            <li class="item enabled" name="circle"><span>Circle</span></li>
            <li class="item" name="square"><span>Square</span></li>
            <li class="item" name="pentagon"><span>Pentagon</span></li>
            <li class="item" name="star"><span>Star</span></li>
          </ul>
        </li>
        <li class="operations">
          <ul class="checkbox">
            <li class="title"><span>Operations</span></li>
            <li class="item enabled" name="translation"><span>Translation</span></li>
            <li class="item" name="rotation"><span>Rotation</span></li>
            <li class="item" name="scale"><span>Scale</span></li>
            <li class="item" name="vertices"><span>Vertices</span></li>
          </ul>
        </li>
        <li class="count">
          <ul>
            <li id="particle-count" class="title"><span>0</span></li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="scripts">
      <script>

        $(function() {

          var two, particles = [], radius = 50, shouldAdd = false;
          var activeShapes = ['circle'];
          var colors = [
            'rgb(255, 64, 64)', 'rgb(255, 128, 0)', 'rgb(0, 200, 255)',
            'rgb(0, 191, 168)', 'rgb(153, 102, 255)', 'rgb(255, 244, 95)'
          ];
          var shapes = {
            triangle: {
              enabled: false,
              make: function() {
                var points = generate(3);
                var poly = new Two.Polygon(points, true);
                return poly;
              }
            },
            circle: {
              enabled: true,
              make: function() {
                var points = generate(8);
                var poly = new Two.Polygon(points, true, true);
                return poly;
              }
            },
            square: {
              enabled: false,
              make: function() {
                var points = generate(4);
                var poly = new Two.Polygon(points, true);
                return poly;
              }
            },
            pentagon: {
              enabled: false,
              make: function() {
                var points = generate(5);
                var poly = new Two.Polygon(points, true);
                return poly;
              }
            },
            star: {
              enabled: false,
              make: function() {
                var r = Math.random() * radius + radius / 2;
                var r2 = r / 2;
                var points = _.map(_.range(10), function(i) {
                  var pct = i / 10;
                  var angle = pct * Math.PI * 2;
                  var x = (i % 2 ? r : r2) * Math.cos(angle);
                  var y = (i % 2 ? r : r2) * Math.sin(angle);
                  var anchor = new Two.Anchor(x, y);
                  return anchor;
                });
                var poly = new Two.Polygon(points, true);
                return poly;
              }
            }
          };
          var operations = {
            translation: {
              enabled: true,
              update: function(particle) {

                var w = particle.scale * particle.rect.width / 2;
                var h = particle.scale * particle.rect.height / 2;

                particle.translation.addSelf(particle.velocity)

                if ((particle.translation.x < w && particle.velocity.x < 0)
                  || (particle.translation.x > two.width - w && particle.velocity.x > 0)) {
                  particle.velocity.x *= -1;
                }

                if ((particle.translation.y < h && particle.velocity.y < 0)
                  || (particle.translation.y > two.height - h && particle.velocity.y > 0)) {
                  particle.velocity.y *= -1;
                }

              }
            },
            rotation: {
              enabled: false,
              update: function(particle) {
                particle.rotation += particle.velocity.rotation;
              }
            },
            scale: {
              enabled: false,
              update: function(particle) {
                particle.scale = particle.velocity.scale * Math.sin(particle.velocity.phase % Math.PI) + 0.5;
                particle.velocity.phase += particle.velocity.frequency;
              }
            },
            vertices: {
              enabled: false,
              update: function(particle) {
                // TODO
              }
            }
          };
          var $window = $(window);

          var $stage = $('#stage').click(function() {
            $('.active').each(function(i, el) {
              $(el).removeClass('active');
            });
          });

          $('.title').each(function(i, el) {
            $(el).click(function() {
              $(this).parent().parent().toggleClass('active');
            });
          });

          $('.item').each(function(i, el) {

            var type = $(el).click(function() {
              switch (type) {
                case 'select':
                  $(this).parent().find('.enabled').each(function(i, el) {
                    $(el).removeClass('enabled');
                  });
                  $(this).addClass('enabled');
                  break;
                case 'checkbox':
                  $(this).toggleClass('enabled');
                  break;
              }
              $window.trigger($(el).attr('name'));
            }).parent().attr('class');

          });

          var $particleCount = $('#particle-count')
            .bind('mousedown touchstart', function() {
              shouldAdd = true;
              $(this).addClass('enabled');
            })
            .bind('mouseup touchend', function() {
              shouldAdd = false;
              $(this).removeClass('enabled');
            })
            .find('span');

          $window
            .bind('resize', function() {

              if (!two) {
                return;
              }

              two.renderer.setSize($window.width(), $window.height());
              two.width = two.renderer.width;
              two.height = two.renderer.height;

            })
            .bind('translation rotation scale vertices', function(e) {

              operations[e.type].enabled = !operations[e.type].enabled;

            })
            .bind('triangle circle square pentagon star', function(e) {

              shapes[e.type].enabled = !shapes[e.type].enabled;
              if (shapes[e.type].enabled) {
                activeShapes.push(e.type);
              } else {
                var index = _.indexOf(activeShapes, e.type);
                if (index >= 0) {
                  activeShapes.splice(index, 1);
                }
              }

            })
            .bind('svg canvas webgl', function(e) {

              initializeStage(e.type);

            });

          // Setup Stage on page load
          (function() {

            var type = /(canvas|webgl)/.test(url.type) ? url.type : 'svg';
            initializeStage(type);
            $('[name=' + type + ']').addClass('enabled');

          })();

          function initializeStage(type) {

            // Remove any previous instances
            _.each(Two.Instances, function(two) {
              Two.Utils.release(two);
              $(two.renderer.domElement).remove();
            });

            Two.Instances.length = 0;

            // Create a new instance
            two = new Two({
              type: Two.Types[type],
              autostart: true
            }).appendTo($stage[0]);

            // Setup the size
            _.extend(two.renderer.domElement.style, {
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0
            });

            $window.resize();

            _.each(particles, function(particle) {

            });

            two.bind('update', update).scene.add(particles);

          }

          function addParticle() {

            var shape = activeShapes[Math.floor(Math.random() * activeShapes.length)];
            var particle = shapes[shape].make();

            particle.velocity = new Two.Vector(Math.random() * 10, Math.random() * 10);
            particle.velocity.rotation = Math.random() * Math.PI  / 8;
            particle.velocity.scale = Math.random() * 2;
            particle.velocity.phase = 0;
            particle.velocity.frequency = Math.random() * Math.PI / 32;
            particle.rect = particle.getBoundingClientRect();
            particle.translation.set(two.width / 2, two.height / 2);

            particle.fill = colors[Math.floor(Math.random() * colors.length)];
            particle.linewidth = 3;
            particle.stroke = '#fff';

            two.scene.add(particle);
            particles.push(particle);

            $particleCount.html(particles.length);

          }

          function update() {

            if (shouldAdd) {
              addParticle();
            }

            _.each(particles, function(particle) {

              _.each(operations, function(operation) {
                if (operation.enabled) {
                  operation.update(particle);
                }
              });

            });

          }

          function generate(amount) {
            var r = Math.random() * radius + radius / 2;
            return _.map(_.range(amount), function(i) {
              var pct = i / amount;
              var angle = pct * Math.PI * 2;
              var x = r * Math.cos(angle);
              var y = r * Math.sin(angle);
              var anchor = new Two.Anchor(x, y);
              return anchor;
            });
          }

        });

      </script>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-40550435-1', 'github.com');
      ga('send', 'pageview');
    </script>
  </body>
</html>